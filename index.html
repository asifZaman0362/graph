<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Graph</title>
  </head>
  <body>
    <canvas id="canvas" width="800" height="800"> </canvas>
    <script>
      let canvas = null;
      let points = [];
      let radius = 5;
      let hoveredPoint = null;
      let hoveredLine = null;

      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top,
        };
      }

      function checkHoverPoints(mouseEvent) {
        let relpos = getMousePos(canvas, mouseEvent);
        let mouse = {
          x: relpos.x,
          y: relpos.y,
        };
        hoveredLine = null;
        for (let i = 1; i < points.length; i++) {
          let prev = points[i - 1];
          let next = points[i];
          let dist = getDistanceFromLine(prev, next, mouse);
          if (dist <= 2) {
            hoveredLine = i - 1;
            break;
          }
        }
        hoveredPoint = null;
        for (let i = 0; i < points.length; i++) {
          let circle = {
            x: points[i].x,
            y: points[i].y,
            radius: radius,
          };
          if (isMouseOverCircle(circle, mouse)) {
            hoveredPoint = i;
            hoveredLine = null;
            break;
          }
        }
        draw(points);
      }

      function setup() {
        canvas = document.querySelector("#canvas");
        canvas.addEventListener("mousemove", checkHoverPoints);
      }

      function getDistanceFromLine(a, b, p) {
        let y1 = p.y,
          x1 = p.x;
        let y0 = a.y,
          x0 = a.x;
        let y = b.y,
          x = b.x;
        let distance =
          Math.abs((y1 - y0) * x - (x1 - x0) * y + x1 * y0 - y1 * x0) /
          Math.sqrt((y1 - y0) * (y1 - y0) + (x1 - x0) * (x1 - x0));
        return distance;
      }

      function isMouseOverLine(line, mouse) {
        let d = getDistanceFromLine(line.a, line.b, mouse);
        return d <= line.strokeWidth;
      }

      function isMouseOverCircle(circle, mouse) {
        let x = circle.x,
          y = circle.y,
          x1 = mouse.x,
          y1 = mouse.y;
        let dist = Math.sqrt((x - x1) * (x - x1) + (y - y1) * (y - y1));
        return dist <= circle.radius;
      }

      function normalised(data) {
        let ret = [];
        let max = data.points[0].x,
          min = data.points[0].x,
          width = data.width;
        data.points.forEach((item) => {
          if (item.x > max) max = item.x;
          else if (item.x < min) min = item.x;
        });
        let diff = max - min;
        let factor = diff / width;
        console.log(factor);
        data.points.forEach((item) => {
          ret.push({
            x: (item.x - min) / factor,
            y: item.y,
          });
        });
        return ret;
      }

      function draw(points) {
        let ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, 1000, 1000);
        ctx.fillStyle = "blue";
        ctx.strokeStyle = "green";
        if (hoveredLine != null) {
          ctx.strokeStyle = "red";
          console.log(hoveredLine);
        }
        ctx.lineWidth = 2;
        ctx.moveTo(points[0].x, points[0].y);
        points.slice(1).map((point) => {
          ctx.lineTo(point.x, point.y);
        });
        ctx.stroke();
        for (let i = 0; i < points.length; i++) {
          let point = points[i];
          ctx.beginPath();
          if (i == hoveredPoint)
            ctx.ellipse(point.x, point.y, 10, 10, 0, 0, Math.PI * 2);
          else ctx.ellipse(point.x, point.y, 5, 5, 0, 0, Math.PI * 2);
          ctx.fill();
        }
        //points.map((point) => {});
      }

      setup();

      const data = {
        startx: 0,
        starty: 0,
        points: [
          { x: 10, y: 50 },
          { x: 25, y: 40 },
          { x: 40, y: 60 },
          { x: 55, y: 90 },
        ],
        width: 800,
        height: 800,
      };

      points = normalised(data);
      draw(points);
    </script>
  </body>
</html>
